workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'push'


variables:
  TEST_DISABLED: 1
  CI_DEBUG_TRACE: "true"


include:
- template: Auto-DevOps.gitlab-ci.yml




debug:
  stage: build
  needs: ["build"]
  image: debian:stable
  script:
  - env


generate:
  stage: build
  needs: ["debug"]
  image: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA
  before_script:
  - echo $CI_JOB_ID
  - echo GE_JOB_ID=$CI_JOB_ID >> generate.env
  script:
  - |
    make || exit 1
    mkdir release
    mv output/org-pdf-latex-output.txt release/
    mv output/fanzine.pdf release/fanzine.pdf
    echo "generation successful"
  artifacts:
    paths:
    - release/fanzine.pdf
    reports:
      dotenv: generate.env



release:
  stage: build
  needs: ["generate"]
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
  - echo 'running release_job'
  - echo 'Previous Job ID is printed below'
  - echo $GE_JOB_ID
  needs:
  - job: generate
    artifacts: true
  release:
    name: Release $CI_COMMIT_SHORT_SHA
    description: Created using the release-cli
    tag_name: "$CI_COMMIT_SHORT_SHA"
    assets:
      links:
      - name: Geometry Lost Fanzine
        url: https://gitlab.com/sgc1000/geometry-lost-fanzine/-/jobs/${GE_JOB_ID}/artifacts/browse/release/
